document.addEventListener('DOMContentLoaded', () => {
    loadNews();

    // Filter Logic
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            filterNews(e.target.getAttribute('data-source'));
        });
    });
});

let allNewsData = [];

async function loadNews() {
    const container = document.getElementById('news-container');
    try {
        const res = await fetch('/api/news/live');
        const json = await res.json();

        if (json.success) {
            allNewsData = json.data;
            renderNews(allNewsData);
        } else {
            const p = document.createElement('p');
            p.className = 'text-center';
            p.textContent = 'Failed to load intel stream.';
            container.replaceChildren(p);
        }
    } catch (e) {
        console.error(e);
        const p = document.createElement('p');
        p.className = 'text-center';
        p.textContent = 'System Offline.';
        container.replaceChildren(p);
    }
}

function renderNews(newsItems) {
    const container = document.getElementById('news-container');
    container.innerHTML = ''; // Safe to clear

    if (newsItems.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No updates found for this category.';
        container.appendChild(p);
        return;
    }

    newsItems.forEach(item => {
        const date = new Date(item.pubDate).toLocaleDateString('en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

        const card = document.createElement('div');
        card.className = 'news-card';

        const content = document.createElement('div');
        content.className = 'nc-content';

        const source = document.createElement('span');
        source.className = 'nc-source';
        source.textContent = item.source;

        const title = document.createElement('h3');
        title.className = 'nc-title';
        title.textContent = item.title;

        const desc = document.createElement('p');
        desc.className = 'nc-desc';
        // Basic strip of HTML tags just in case, then treat as text
        desc.textContent = item.snippet.replace(/<[^>]*>?/gm, '');

        content.append(source, title, desc);

        const footer = document.createElement('div');
        footer.className = 'nc-footer';

        const timeSpan = document.createElement('span');
        timeSpan.innerHTML = `<i class="fa-regular fa-clock"></i> ${date}`; // Safe as date is generated by JS

        const link = document.createElement('a');
        link.href = item.link;
        link.target = '_blank';
        link.innerHTML = 'Read Full <i class="fa-solid fa-external-link-alt"></i>';

        footer.append(timeSpan, link);
        card.append(content, footer);
        container.appendChild(card);
    });
}

function filterNews(source) {
    if (source === 'all') {
        renderNews(allNewsData);
    } else {
        const filtered = allNewsData.filter(item => item.source === source);
        renderNews(filtered);
    }
}
